<!DOCTYPE html>
<html>
<head>
    <title>Communication Aid</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/pose@0.8/dist/teachablemachine-pose.min.js"></script>
    
    <style>
      /* Keep the style for visual clarity */
      #webcam-container {
        margin: 10px auto;
        width: 320px;
        height: 240px;
        border: 3px solid #00A9E0;
      }
      #label-container {
        font-size: 28px;
        font-weight: bold;
        text-align: center;
        color: #CC0000;
        margin-top: 10px;
      }
    </style>
</head>
<body>
    
    <div id="webcam-container"></div>
    <div id="label-container">LOADING MACHINE LEARNING MODEL...</div>
    
    <audio id="audio-alert" src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAIBAAEABAA4eGFyegAAAAAAAAAAAENLSUJSAAAAD2RhdGEAAAAoAAAA..." preload="auto"></audio>

    <script type="text/javascript">
        // *** 1. PASTE YOUR UNIQUE MODEL URL HERE ***
        const URL = "https://teachablemachine.withgoogle.com/models/qLMkiB_Zn/"; 
        
        let model, webcam, labelContainer, maxPredictions;
        let messageSpoken = false; 

        // --- CONFIGURATION ---
        const COMMUNICATION_MESSAGE = "I need help, please!";
        const CONFIDENCE_THRESHOLD = 0.80; 

        // Function to speak the message using the standard browser API
        function speakMessage() {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(COMMUNICATION_MESSAGE);
                window.speechSynthesis.speak(utterance);
            }
        }

        async function init() {
            const modelURL = URL + "model.json";
            const metadataURL = URL + "metadata.json";
            
            try {
                // CRITICAL FIX: Requesting a compressed model (uint8)
                model = await tmPose.load(modelURL, metadataURL, { quantization: 'uint8' });
                maxPredictions = model.getTotalClasses();

                // Setup the webcam for video input
                const size = 200;
                const flip = true;
                webcam = new tmPose.Webcam(size, size, flip);
                await webcam.setup();
                await webcam.play();
                window.requestAnimationFrame(loop);

                document.getElementById("webcam-container").appendChild(webcam.canvas);
                labelContainer = document.getElementById("label-container");
                
                labelContainer.innerHTML = "Ready! Look at the camera.";
                
            } catch (error) {
                labelContainer.innerHTML = "ERROR: Failed to load model. Check Console (F12).";
                console.error("Model Loading Error:", error);
            }
        }

        async function loop(timestamp) {
            if (!webcam || !model) {
                window.requestAnimationFrame(loop);
                return;
            }
            webcam.update();
            await predict();
            window.requestAnimationFrame(loop);
        }

        async function predict() {
            const { prediction } = await model.predict(webcam.canvas);
            
            let highestPrediction = { className: "Unknown", probability: 0 };
            for (let i = 0; i < maxPredictions; i++) {
                if (prediction[i].probability > highestPrediction.probability) {
                    highestPrediction = { 
                        className: prediction[i].className, 
                        probability: prediction[i].probability 
                    };
                }
            }
            
            labelContainer.innerHTML = highestPrediction.className + " (" + (highestPrediction.probability * 100).toFixed(0) + "%)";

            // LOGIC FOR TWO DIFFERENT TRIGGERS: "Arm UP" OR "Head Tilt"
            const isTriggerPose = (
                highestPrediction.className === "Arm UP" ||
                highestPrediction.className === "Head Tilt"
            );

            if (isTriggerPose && highestPrediction.probability > CONFIDENCE_THRESHOLD && !messageSpoken) {
                
                // Speak the message using the simplified function
                speakMessage();
                
                messageSpoken = true;

                labelContainer.innerHTML = "ðŸ“¢ **MESSAGE SENT!** ðŸ“¢"; 
                
            } else if (highestPrediction.className === "Neutral" && highestPrediction.probability > CONFIDENCE_THRESHOLD) {
                messageSpoken = false;
                
            }
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>
